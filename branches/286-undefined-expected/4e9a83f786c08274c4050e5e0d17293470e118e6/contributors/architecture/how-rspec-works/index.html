
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="User- and contributor-facing documentation for SuperDiff">
      
      
      
      
        <link rel="prev" href="../introduction/">
      
      
        <link rel="next" href="../how-super-diff-works/">
      
      
      <link rel="icon" href="../../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.5.3, mkdocs-material-9.5.18">
    
    
      
        <title>How RSpec works - SuperDiff Documentation</title>
      
    
    
      <link rel="stylesheet" href="../../../assets/stylesheets/main.66ac8b77.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../../stylesheets/extra.css">
    
    <script>__md_scope=new URL("../../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    <body dir="ltr">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#how-rspec-works" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow md-header--lifted" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../../.." title="SuperDiff Documentation" class="md-header__button md-logo" aria-label="SuperDiff Documentation" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            SuperDiff Documentation
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              How RSpec works
            
          </span>
        </div>
      </div>
    </div>
    
    
      <script>var media,input,key,value,palette=__md_get("__palette");if(palette&&palette.color){"(prefers-color-scheme)"===palette.color.media&&(media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']"),palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent"));for([key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
  </nav>
  
    
      
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
    <li class="md-tabs__item">
      <a href="../../.." class="md-tabs__link">
        
  
    
  
  Home

      </a>
    </li>
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../../users/" class="md-tabs__link">
          
  
  User Documentation

        </a>
      </li>
    
  

      
        
  
  
    
  
  
    
    
      <li class="md-tabs__item md-tabs__item--active">
        <a href="../../" class="md-tabs__link">
          
  
  Contributor Documentation

        </a>
      </li>
    
  

      
    </ul>
  </div>
</nav>
    
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


  

<nav class="md-nav md-nav--primary md-nav--lifted md-nav--integrated" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../.." title="SuperDiff Documentation" class="md-nav__button md-logo" aria-label="SuperDiff Documentation" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    SuperDiff Documentation
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../.." class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Home
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" >
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    User Documentation
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            User Documentation
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../users/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Introduction to SuperDiff
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../users/getting-started/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Getting Started
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../users/customization/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Customizing SuperDiff
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
    
      
        
        
      
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" checked>
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="">
            
  
  <span class="md-ellipsis">
    Contributor Documentation
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            Contributor Documentation
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Home
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../how-to-contribute/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    How to Contribute
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_3" checked>
        
          
          <label class="md-nav__link" for="__nav_3_3" id="__nav_3_3_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Architecture
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_3_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_3_3">
            <span class="md-nav__icon md-icon"></span>
            Architecture
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../introduction/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Introduction
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  <span class="md-ellipsis">
    How RSpec works
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  <span class="md-ellipsis">
    How RSpec works
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#context" class="md-nav__link">
    <span class="md-ellipsis">
      Context
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#rspecs-cast-of-characters" class="md-nav__link">
    <span class="md-ellipsis">
      RSpec's cast of characters
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#what-rspec-does" class="md-nav__link">
    <span class="md-ellipsis">
      What RSpec does
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../how-super-diff-works/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    How SuperDiff works
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../structure/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Structure
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


<h1 id="how-rspec-works">How RSpec works</h1>
<p>In order to understand how the RSpec integration in SuperDiff works,
it&rsquo;s important to study the pieces in play within RSpec itself.</p>
<h2 id="context">Context</h2>
<p>Imagine a file such as the following:</p>
<div class="highlight"><pre><span></span><code><span class="c1"># spec/some_spec.rb</span>
<span class="n">describe</span><span class="w"> </span><span class="s2">&quot;Some tests&quot;</span><span class="w"> </span><span class="k">do</span>
<span class="w">  </span><span class="n">it</span><span class="w"> </span><span class="s2">&quot;does something&quot;</span><span class="w"> </span><span class="k">do</span>
<span class="w">    </span><span class="n">expect</span><span class="p">(</span><span class="o">[</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="o">]</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="w"> </span><span class="n">eq</span><span class="p">(</span><span class="o">[</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">6</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="o">]</span><span class="p">)</span>
<span class="w">  </span><span class="k">end</span>
<span class="k">end</span>
</code></pre></div>
<p>Then, imagine that the user runs:</p>
<div class="highlight"><pre><span></span><code>rspec
</code></pre></div>
<p>Without SuperDiff activated,
this will produce the following output:</p>
<div class="highlight"><pre><span></span><code>Some tests
  does something (FAILED - 1)

Failures:

  1) Some tests does something
     Failure/Error: expect([1, 2, 3]).to eq([1, 6, 3])

       expected: [1, 6, 3]
            got: [1, 2, 3]

       (compared using ==)
     # ./spec/some_spec.rb:3:in `block (2 levels) in &lt;top (required)&gt;&#39;

Finished in 0.01186 seconds (files took 0.07765 seconds to load)
1 example, 1 failure

Failed examples:

rspec ./spec/some_spec.rb:2 # Some tests does something
</code></pre></div>
<p>Now imagine that we want to modify this output
to replace the &ldquo;expected:&rdquo;/&rdquo;actual:&rdquo; lines with a diff.
How would we do this?</p>
<h2 id="rspecs-cast-of-characters">RSpec&rsquo;s cast of characters</h2>
<p>First, we will review several concepts in RSpec: <sup id="fnref:fn1"><a class="footnote-ref" href="#fn:fn1">1</a></sup></p>
<ul>
<li>Since RSpec tests are &ldquo;just Ruby&rdquo;,
  parts of tests map to objects
  which are created when those tests are loaded.
  <code>describe</code>s and <code>context</code>s are represented by
  <strong>example groups</strong>,
  instances of <a href="https://github.com/rspec/rspec-core/blob/v3.13.0/lib/rspec/core/example_group.rb"><code>RSpec::Core::ExampleGroup</code></a>,
  and <code>it</code>s and <code>specify</code>s are represented by
  <strong>examples</strong>,
  instances of <a href="https://github.com/rspec/rspec-core/blob/v3.13.0/lib/rspec/core/example.rb"><code>RSpec::Core::Example</code></a>.</li>
<li>Most notably,
  within tests themselves,
  the <code>expect</code> method —
  <a href="https://github.com/rspec/rspec-expectations/blob/v3.13.0/lib/rspec/expectations/syntax.rb#L73">mixed into tests via the syntax layer</a> —
  returns an instance of <a href="https://github.com/rspec/rspec-expectations/blob/v3.13.0/lib/rspec/expectations/expectation_target.rb"><code>RSpec::Expectations::ExpectationTarget</code></a>,
  and may raise an error if the check it is performing fails.</li>
<li><strong>Configuration</strong> is kept in an instance of <a href="https://github.com/rspec/rspec-core/blob/v3.13.0/lib/rspec/core/configuration.rb"><code>RSpec::Core::Configuration</code></a>,
  which is accessible via <code>RSpec.configuration</code>
  and is <a href="https://github.com/rspec/rspec-core/blob/v3.13.0/lib/rspec/core.rb#L86">initialized the first time it&rsquo;s used</a></li>
<li>The <strong>runner</strong>,
  an instance of <a href="https://github.com/rspec/rspec-core/blob/v3.13.0/lib/rspec/core/runner.rb"><code>RSpec::Core::Runner</code></a>,
  is the entrypoint to all of RSpec —
  <a href="https://github.com/rspec/rspec-core/blob/v3.13.0/exe/rspec#L4">it&rsquo;s called directly by the <code>rspec</code> executable</a> —
  and executes the tests the user has specified.</li>
<li><strong>Formatters</strong> change RSpec&rsquo;s output after running tests.
  Since the user can specify one formatter when running <code>rspec</code>,
  the collection of registered formatters is managed by the formatter loader,
  an instance of <a href="https://github.com/rspec/rspec-core/blob/v3.13.0/lib/rspec/core/formatters.rb#L96"><code>RSpec::Core::Formatters::Loader</code></a>.
  The default formatter is &ldquo;progress&rdquo;,
  <a href="https://github.com/rspec/rspec-core/blob/v3.13.0/lib/rspec/core/configuration.rb#L1030">set in the configuration object</a>,
  which maps to an instance of <a href="https://github.com/rspec/rspec-core/blob/v3.13.0/lib/rspec/core/formatters/progress_formatter.rb"><code>RSpec::Core::Formatters::ProgressFormatter</code></a>.</li>
<li><strong><a href="https://github.com/rspec/rspec-core/blob/v3.13.0/lib/rspec/core/notifications.rb">Notifications</a></strong>
  represent events that occur while running tests,
  such as &ldquo;these tests failed&rdquo;
  or &ldquo;this test was skipped&rdquo;.</li>
<li>The <strong>reporter</strong>,
  an instance of <a href="https://github.com/rspec/rspec-core/blob/v3.13.0/lib/rspec/core/reporter.rb"><code>RSpec::Core::Reporter</code></a>,
  acts as sort of the brain of the whole operation.
  Implementing a publish/subscribe model,
  it tracks the state of tests as they are run,
  including errors captured during the process,
  packaging key moments into notifications
  and delegating them to all registered formatters (or anything else listening to the reporter).
  Like the configuration object,
  it is also global,
  accessible via the configuration object,
  and is <a href="https://github.com/rspec/rspec-core/blob/v3.13.0/lib/rspec/core/configuration.rb#L1056">initialized the first time it&rsquo;s used</a></li>
<li>The <strong>exception presenter</strong>,
  an instance of <a href="https://github.com/rspec/rspec-core/blob/v3.13.0/lib/rspec/core/formatters/exception_presenter.rb"><code>RSpec::Core::Formatters::ExceptionPresenter</code></a>,
  is a special type of formatter
  which does not respond to events,
  but is rather responsible for managing all of the logic involved
  in building all of the output that appears
  when a test fails.</li>
</ul>
<h2 id="what-rspec-does">What RSpec does</h2>
<p>Given the above, RSpec performs the following sequence of events:</p>
<ol>
<li>The developer adds an failing assertion to a test using the following forms
   (filling in <code>&lt;actual value&gt;</code>, <code>&lt;matcher&gt;</code>, <code>&lt;block&gt;</code>, and <code>&lt;args...&gt;</code> appropriately):<ul>
<li><code>expect(&lt;actual value&gt;).to &lt;matcher&gt;(&lt;args...&gt;)</code></li>
<li><code>expect { &lt;block&gt; }.to &lt;matcher&gt;(&lt;args...&gt;)</code></li>
<li><code>expect(&lt;actual value&gt;).not_to &lt;matcher&gt;(&lt;args...&gt;)</code></li>
<li><code>expect { &lt;block&gt; }.not_to &lt;matcher&gt;(&lt;args...&gt;)</code></li>
</ul>
</li>
<li>The developer runs the test using the <code>rspec</code> executable.</li>
<li>The <code>rspec</code> executable <a href="https://github.com/rspec/rspec-core/blob/v3.13.0/exe/rspec#L4">calls <code>RSpec::Core::Runner.invoke</code></a>.</li>
<li>Skipping a few steps, <code>RSpec::Core::Runner#run_specs</code> is called,
   which <a href="https://github.com/rspec/rspec-core/blob/v3.13.0/lib/rspec/core/runner.rb#L115">runs all tests by surrounding them in a call to <code>RSpec::Core::Reporter#report</code></a>.</li>
<li>Skipping a few more steps, <a href="https://github.com/rspec/rspec-core/blob/v3.13.0/lib/rspec/core/example_group.rb#L646"><code>RSpec::Core::Example#run</code> is called to run the current example</a>.</li>
<li>From here one of two paths is followed
   depending on whether the assertion is positive (<code>.to</code>) or negative (<code>.not_to</code>).<ul>
<li>If the assertion is positive:<ol>
<li>Within the test,
   after <code>expect</code> is called to build a <code>RSpec::Expectations::ExpectationTarget</code>,
   <a href="https://github.com/rspec/rspec-expectations/blob/v3.13.0/lib/rspec/expectations/expectation_target.rb#L65">the <code>to</code> method calls <code>RSpec::Expectations::PositiveExpectationHandler.handle_matcher</code></a>.</li>
<li>The matcher is then used to know
   whether the assertion passes or fails:
   <code>PositiveExpectationHandler</code>
   <a href="https://github.com/rspec/rspec-expectations/blob/v3.13.0/lib/rspec/expectations/handler.rb#L51">calls the <code>matches?</code> method on the matcher</a>.</li>
<li>Assuming that <code>matches?</code> returns false,
   <code>PositiveExpectationHandler</code> then <a href="https://github.com/rspec/rspec-expectations/blob/v3.13.0/lib/rspec/expectations/handler.rb#L56">calls <code>RSpec::Expectations::ExpectationHelper.handle_failure</code></a>,
   telling it to get the positive failure message from the matcher
   by calling <code>failure_message</code>.</li>
</ol>
</li>
<li>If the assertion is negative:</li>
<li>Within the test,
     after <code>expect</code> is called to build a <code>RSpec::Expectations::ExpectationTarget</code>,
     <a href="https://github.com/rspec/rspec-expectations/blob/v3.13.0/lib/rspec/expectations/expectation_target.rb#L78">the <code>not_to</code> method calls <code>RSpec::Expectations::NegativeExpectationHandler.handle_matcher</code></a>.</li>
<li>The matcher is then used to know
     whether the assertion passes or fails:
     <code>NegativeExpectationHandler</code>,
     <a href="https://github.com/rspec/rspec-expectations/blob/v3.13.0/lib/rspec/expectations/handler.rb#L79">calls the <code>does_not_match?</code> method on the matcher</a>.</li>
<li>Assuming that <code>does_not_match?</code> returns false,
     <code>NegativeExpectationHandler</code> then [calls <code>RSpec::Expectations::ExpectationHelper.handle_failure</code>][via <code>NegativeExpectationHandler</code>]<a href="https://github.com/rspec/rspec-expectations/blob/v3.13.0/lib/rspec/expectations/handler.rb#L84">rspec-expectation-helper-handle-failure-call-negative</a>,
     telling it to get the negative failure message from the matcher
     by calling <code>failure_message_when_negated</code>.</li>
</ul>
</li>
<li><code>RSpec::Expectations::ExpectationHelper.handle_failure</code> <a href="https://github.com/rspec/rspec-expectations/blob/v3.13.0/lib/rspec/expectations/handler.rb#L37-L41">calls <code>RSpec::Expectations.fail_with</code></a>.</li>
<li><code>RSpec::Expectations.fail_with</code> <a href="https://github.com/rspec/rspec-expectations/blob/v3.13.0/lib/rspec/expectations/fail_with.rb#L27-L35">creates a diff using <code>RSpec::Matchers::MultiMatcherDiff</code>,
   wraps it in an exception,
   and feeds the exception to <code>RSpec::Support.notify_failure</code></a>.</li>
<li><code>RSpec::Support.notify_failure</code> calls the currently set failure notifier,
   which by default <a href="https://github.com/rspec/rspec-support/blob/v3.13.0/lib/rspec/support.rb#L110">raises the given exception</a>.</li>
<li>Returning to <code>RSpec::Core::Example#run</code>,
   this method <a href="https://github.com/rspec/rspec-core/blob/v3.13.0/lib/rspec/core/example.rb#L280">rescues the exception</a>
   and then calls <code>finish</code>,
   which <a href="https://github.com/rspec/rspec-core/blob/v3.13.0/lib/rspec/core/reporter.rb#L145">calls <code>example_failed</code> on the reporter</a>.</li>
<li><code>RSpec::Core::Reporter#example_failed</code> uses <code>RSpec::Core::Notifications::ExampleNotification.for</code>
   to <a href="https://github.com/rspec/rspec-core/blob/v3.13.0/lib/rspec/core/notifications.rb#L52">construct a notification</a>,
   which in this case is an <code>RSpec::Core::Notifications::FailedExampleNotification</code>.
   <code>RSpec::Core::Notifications::FailedExampleNotification</code> in turn
   <a href="https://github.com/rspec/rspec-core/blob/v3.13.0/lib/rspec/core/notifications.rb#L213">constructs an <code>RSpec::Core::Formatters::ExceptionPresenter</code></a>.</li>
<li><code>RSpec::Core::Reporter#example_failed</code> then <a href="https://github.com/rspec/rspec-core/blob/v3.13.0/lib/rspec/core/reporter.rb#L145">passes the notification object
   along with an event of <code>:example_failed</code> to the <code>notify</code> method</a>.
   Because <code>RSpec::Core::Formatters::ProgressFormatter</code> is a listener on the reporter,
   <a href="https://github.com/rspec/rspec-core/blob/v3.13.0/lib/rspec/core/reporter.rb#L209">its <code>example_failed</code> method gets called</a>,
   which prints a message <code>Failure:</code> to the terminal.</li>
<li>Returning to <code>RSpec::Core::Reporter#report</code>,
   it now <a href="https://github.com/rspec/rspec-core/blob/v3.13.0/lib/rspec/core/reporter.rb#L76">calls <code>finish</code> after all tests are run</a>.</li>
<li><code>RSpec::Core::Reporter#finish</code> <a href="https://github.com/rspec/rspec-core/blob/v3.13.0/lib/rspec/core/reporter.rb#L178">notifies listeners of the <code>:dump_failures</code> event</a>,
   this time using an instance of <code>RSpec::Core::Notifications::ExamplesNotification</code>.
   Again, because <code>RSpec::Core::Formatters::ProgressFormatter</code> is registered,
   its <code>dump_failures</code> method is called,
   which is actually defined in <code>RSpec::Core::Formatters::BaseTextFormatter</code>.</li>
<li><code>RSpec::Core::Formatters::BaseTextFormatter#dump_failures</code>
   <a href="https://github.com/rspec/rspec-core/blob/v3.13.0/lib/rspec/core/formatters/base_text_formatter.rb#L32">calls <code>RSpec::Core::Notifications::ExamplesNotification#fully_formatted_failed_examples</code></a>.</li>
<li><code>RSpec::Core::Notifications::ExamplesNotification#fully_formatted_failed_examples</code>
   <a href="https://github.com/rspec/rspec-core/blob/v3.13.0/lib/rspec/core/notifications.rb#L114">formats all of the failed examples</a>
   by wrapping them in <code>RSpec::Core::Notifications::FailedExampleNotification</code>s and calling <code>fully_formatted</code> on them.</li>
<li><code>RSpec::Core::Notifications::FailedExampleNotification#fully_formatted</code> then <a href="https://github.com/rspec/rspec-core/blob/v3.13.0/lib/rspec/core/notifications.rb#L202">calls <code>fully_formatted</code>
   on its <code>RSpec::Core::Formatters::ExceptionPresenter</code></a>.</li>
<li><code>RSpec::Core::Formatters::ExceptionPresenter#fully_formatted</code> then <a href="https://github.com/rspec/rspec-core/blob/v3.13.0/lib/rspec/core/formatters/exception_presenter.rb#L84-L100">constructs various pieces
   of what will eventually be printed to the terminal</a>,
   including the name of the test,
   the line that failed,
   the error and backtrace,
   and other pertinent details.</li>
</ol>
<div class="footnote">
<hr />
<ol>
<li id="fn:fn1">
<p>Note that the analysis of the RSpec source code in this document is accurate as of RSpec v3.13.0, released February 4, 2024.&#160;<a class="footnote-backref" href="#fnref:fn1" title="Jump back to footnote 1 in the text">&#8617;</a></p>
</li>
</ol>
</div>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-copyright__highlight">
      ©️ Elliot Winkler; Splitwise, Inc.
    </div>
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
      <div class="md-progress" data-md-component="progress" role="progressbar"></div>
    
    
    <script id="__config" type="application/json">{"base": "../../..", "features": ["navigation.instant", "navigation.instant.progress", "navigation.tabs", "navigation.tabs.sticky", "navigation.path", "toc.integrate"], "search": "../../../assets/javascripts/workers/search.b8dbb3d2.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../../../assets/javascripts/bundle.3220b9d7.min.js"></script>
      
    
  </body>
</html>